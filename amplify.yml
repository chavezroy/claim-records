version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        # Write environment variables to .env.production for Amplify Hosting Compute runtime
        # Amplify Console provides variables at build-time, but they need to be in .env.production
        # for Next.js to bundle them into the Lambda/serverless runtime
        - |
          echo "Writing environment variables to .env.production..."
          echo "=== Debug: Available environment variables (NEXTAUTH* only) ==="
          env | grep -i "NEXTAUTH" || echo "No NEXTAUTH variables found in environment"
          echo "=== End Debug ==="
          echo "DATABASE_URL=$DATABASE_URL" >> .env.production
          echo "USE_MOCK_DATA=$USE_MOCK_DATA" >> .env.production
          echo "USE_MOCK_AUTH=$USE_MOCK_AUTH" >> .env.production
          # Trim whitespace from NEXTAUTH_SECRET if present
          NEXTAUTH_SECRET_TRIMMED=$(echo "$NEXTAUTH_SECRET" | xargs)
          if [ -z "$NEXTAUTH_SECRET_TRIMMED" ]; then
            echo "WARNING: NEXTAUTH_SECRET not available from Amplify Console environment variables"
            echo "Using workaround: hardcoded value from verified Amplify Console setting"
            # Workaround: Use verified value from Amplify Console since env var isn't being passed correctly
            # This is a temporary solution until Amplify platform issue is resolved
            echo "NEXTAUTH_SECRET=ZCHyOQqY4w7Sei8ss23Xv2qiSiCShQkzvgQDfGNN7lePE=" >> .env.production
            echo "✓ NEXTAUTH_SECRET written via workaround (length: 46)"
          else
            echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET_TRIMMED" >> .env.production
            echo "✓ NEXTAUTH_SECRET written from environment variable (length: ${#NEXTAUTH_SECRET_TRIMMED})"
          fi
          echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env.production
          echo "NODE_ENV=$NODE_ENV" >> .env.production
          echo "PAYPAL_CLIENT_ID=$PAYPAL_CLIENT_ID" >> .env.production
          echo "PAYPAL_CLIENT_SECRET=$PAYPAL_CLIENT_SECRET" >> .env.production
          echo "PAYPAL_MODE=$PAYPAL_MODE" >> .env.production
          echo "Environment variables written to .env.production"
          echo "Verifying .env.production contents (without values):"
          grep -E "^[A-Z_]+=" .env.production | sed 's/=.*/=***/' || echo "No .env.production file found"
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*

